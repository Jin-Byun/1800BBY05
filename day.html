<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hej!</title>
    <meta name="comp1800 boilerplate code" content="my bcit project">
    <meta name="author" content="BCIT">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">

    <!-- Bootstrap, firebase-auth-ui -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!-- Bootstrap FirebaseUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>


    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <!-- Optional styles and scripts of your own -->
    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">
    <link type="text/css" href="styles/my_style.css">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body{

    background-color:#fffaec;
    }

    .navbar {

    background-color: #f5efdf  !important;
        border-bottom: solid 2px #f37f5230;
    }

    .navbar-brand {
        font-size: 2rem;
        font-weight: bold;
         color: #f37f52 !important;
         line-height: 0.6;
         text-shadow: 2px 2px 1px yellow;
    }

    .fixed-bottom {
    background-color:#f5efdf !important;
    border-top: solid 2px #f37f5230;
}


    html, body {
        /* overflow: hidden; */
        height: 100%;
        width: 100%;
    }
    section {
        margin: 0%;
        height: 40vh;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clock {
        height: 40vh;
        width: 40vh;
        border-radius: 50%;
        border: 5px solid #f37f52;
        display: grid;
        grid-template-columns: 1;
        grid-template-rows: 1;
    }

    span {
        position: absolute;
        color: whitesmoke;
        background-color: #f37f52;
        border-radius: 30%;
        text-shadow: 0 0 3px black;
        transform-origin: top left;
        grid-row: 1;
        grid-column: 1;
    }

    .clock > .cap, .hour, .minute {
        grid-column: 1;
        grid-row: 1;
        position: relative;
        top: 50%;
        left: 50%;
        border: 2px solid rgba(0,0,0,0.3);
        transform: rotate(-90deg);
        transform-origin: left;
        background-color: #f37f52;
    }

    .clock > canvas {
        position: relative;
        grid-column: 1;
        grid-row: 1;
        transform: rotate(1deg);
        z-index: -1;
    }

    .cap {
        top: 50%;
        width: 7px;
        height: 7px;
        background-color: #f37f52!important;
        border-radius: 50%;
    }

    .hour {
        width: 30%;
        height: 5px;
    }

    .minute {
        width: 45%;
        height: 3px;
    }

    footer > a {
        color: #f37f52;
        text-shadow: 1px 0px #f37f52, -1px 0px #f37f52, 0px 1px #f37f52, 0px -1px #f37f52;
    }

</style>

</head>

<body>

    <!-------------------------------------->
    <!-- The following is HTML for layout -->
    <!-------------------------------------->
    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-secondary">
        <div class="container-fluid">
            <a class="navbar-brand" href="./frontpage.html">HEJ!</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <div style="float: right;">
                        <input id="title" type="text">
                    </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- welcome and main part of the page -->
    
    <div class="container text-center">
        <h1 id="date-go-here"></h1>
</div>
    
    <br/>
    <section>
        <div class="clock">
            <div class="hour"></div>
            <div class="minute"></div>
            <div class="cap"></div>
        </div>
    </section>

    <!-- Templates for general use, not displayed -->
    <template id=CardTemplate>
        <div class="card py-2 mx-2" style="width: 18rem;">
            <div class="card-body">
                <h5 class="card-title">Card title</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                    card's content.</p>
                    <button type="button" class="btn btn-primary" onclick="ToggleCounter()">&lt;done&gt;</button>
                </div>
        </div>
    </template>

<br/>  

<div class="container">
    <h3 id="to_do_date" style="margin-left: 5%;"></h3>
        <!-- Here is container for cards  -->
    <div class="container">
        <div id="reminders-go-here" class="row row-cols-auto">
        </div>
    </div>
</div>

    
<div class="fixed-bottom py-3 bg-secondary align-items-center">
    <div class="container text-center py-0">
        <footer class="navbar bg-secondary fixed-bottom py-0">
            <a href="calendar.html" i class="bi bi-arrow-left-circle mx-3 "
                style="font-size:  2em;"></a>
            <a href="calendar.html" class="bi bi-calendar-date" style="font-size: 2em; "></a>
            <a href="create_schedule.html" class="bi bi-plus-circle mx-3" style="font-size: 3em;"></a>
            <a href="create_schedule.html" class="bi bi-trophy" style="font-size: 2em;"></a>
            <a href="profile_user.html" i class="bi bi-person mx-3" style="font-size: 2em;"></a>

        </footer>
    </div>
</div>
    <!--------------------------------------------------------------------->
    <!-- JS files: Your own JavaScript functions included here    -->
    <!--------------------------------------------------------------------->
    <script>
        var userID;
        var count = 0;
        var reminderList = [];
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
            "October", "November", "December"
        ]
        const ang2rad = (angle) => {
            return angle * (Math.PI/180); 
        };
        const diameter = document.querySelector(".clock").offsetWidth;
        const radius = diameter / 2;
        const clock = document.querySelector(".clock");
        const time = ['00', '04', '08', '12', '16', '20'];
        const collist = ["#00ff0080", "#00ff0080", "#ffff0080", "#ffff0080", "#ff000080", "#ff000080", "#00000080", "#00000080"]

        let angle = -89.8;
        const deltaAngle = 360 / time.length;

        time.forEach(char => {
            const charElement = document.createElement('span');
            charElement.innerText = char;
            const xPos = radius - 12 + radius * Math.cos(ang2rad(angle));
            const yPos = radius - 14.5 + radius * Math.sin(ang2rad(angle));
            const spread = `translate(${xPos}px, ${yPos}px)`;
            charElement.style.transform = spread;
            angle += deltaAngle;
            clock.appendChild(charElement);
        });

        function displayRems() {
            let CardTemplate = document.getElementById("CardTemplate");
            let urlstring = new URL(window.location.href);
            let stringSplit = urlstring.searchParams.get("uid").split('?');
            let currUID = stringSplit[0];
            db.collection("reminders").where("UserID", "==", currUID).get()
                .then(snap => {
                    var i = 1;
                    snap.forEach(doc => { //iterate thru each doc
                        var title = doc.data().Name;
                        var details = doc.data().Time;
                        let newcard = CardTemplate.content.cloneNode(true);

                        //update title and text and image
                        newcard.querySelector('.card-title').innerHTML = title;
                        newcard.querySelector('.card-text').innerHTML = details;
//updates href, so we can click.
                            // newcard.querySelector('.card-href').href = "details.html?collection=" + 2 +
                            // "?id=" + doc.id; //firestore doc ID

                        //give unique ids to all elements for future use
                        newcard.querySelector('.card-title').setAttribute("id", "ctitle" + i);
                        newcard.querySelector('.card-text').setAttribute("id", "ctext" + i);
                        //attach to gallery
                        document.getElementById("reminders-go-here").appendChild(newcard);
                        

                    })
                })
                
        }
displayRems();
        //-------------------------
        //the hands of the clock
        //-------------------------
        const hrE1 = document.querySelector(".hour");
        const minE1 = document.querySelector(".minute"); 
        var date = new Date;
        var hrdeg = date.getHours()/24*360-90;
        var mindeg = date.getMinutes()/60*360-90;
        minE1.style.transform = `rotate(${mindeg}deg)`;
        hrE1.style.transform = `rotate(${hrdeg}deg)`;
        setInterval(()=>{
            date = new Date;
            hrdeg = date.getHours()/24*360-90 + (date.getMinutes()/(24*60)*360);
            mindeg = date.getMinutes()/60*360-90;
            minE1.style.transform = `rotate(${mindeg}deg)`;
            hrE1.style.transform = `rotate(${hrdeg}deg)`;
        },1000)

        function showDetails() {
      // create a URL object
      let params = new URL(window.location.href);
      let data = params.searchParams.get("uid").split('?'); // data[0] = uid, 1 = year, 2= month, 3 = date
      let message = data[1] + " " + data[2] + " " + data[3];    
      document.getElementById("date-go-here").innerHTML = message;
    let currentUser = db.collection("users").doc(data[0])
    currentUser.get().then(userDoc => {
        //get user name
        fullName = userDoc.data().name.split(' ');
        firstName = fullName[0];
        let todoheading = firstName + ", " + 
        (date.getFullYear() == data[1] && months[date.getMonth()] == data[2] && date.getDate() == data[3] ? "for today" : "on " + (data[1] + " " + data[2] + " " + data[3])) + ":";
        document.getElementById("to_do_date").innerHTML = todoheading;
    })   
 }
showDetails();
getReminder();

function makeScheduleArc() {
    for(let i = 0; i < count; i++) {
    clock.insertAdjacentHTML("afterbegin", `<canvas id="reminder${i}" width="${diameter}" height="${diameter}"></canvas>`);
    let timeSplit = reminderList[i].Time.split(':');
    let startangle = (timeSplit[0]/24*360-90)*Math.PI/180 + (timeSplit[1]/(60*24)*2*Math.PI);
    let endangle = startangle + 1/24*2*Math.PI;
    console.log(reminderList[i].Time, startangle, endangle);
    let c = document.getElementById("reminder" + i);
    let ctx = c.getContext('2d');
    ctx.fillStyle = collist[i];
    ctx.beginPath();
    ctx.moveTo(radius, radius);
    ctx.arc(radius-4, radius-6, radius-2, startangle, endangle, false);
    ctx.lineTo(radius, radius);
    ctx.fill();
    ctx.stroke();
    ctx.closePath();
    }
}

function getReminder() {
    let params = new URL(window.location.href);
      let datedata = params.searchParams.get("uid").split('?');
      let year = datedata[1];
      let month = months.indexOf(datedata[2]);
      let date = datedata[3];
      let message = "";
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                userID = user.uid;
                var activities = [];
                var reminderRef = db.collection("reminders");
                reminderRef.where("UserID", "==", userID).get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            activities.push(doc.data());
                            //             // doc.data() is never undefined for query doc snapshots
                        });
                        let dailies = [];
                        let weeklies = [];
                        let biweeklies = [];
                        activities.forEach(element => {
                            if (element.Frequency == "daily") {
                                dailies.push(element);
                            } else if (element.Frequency == "weekly") {
                                weeklies.push(element);
                            } else {
                                biweeklies.push(element);
                            }
                        });
                        // console.log(new Date(dailies[0].TimeStamp).getDay(), new Date(year, month, date).getDay());
                        for (let i = 0; i < dailies.length; i++) {
                            if (year > new Date(dailies[i].TimeStamp).getFullYear() || (year == new Date(dailies[i].TimeStamp).getFullYear() &&
                                    month > new Date(dailies[i].TimeStamp).getMonth())) {
                                        count++;
                                        reminderList.push(dailies[i]);
                                message += dailies[i].Name + ' @ ' + dailies[i].Time + "\r\n";
                            } else if (year == new Date(dailies[i].TimeStamp).getFullYear() && month == new Date(dailies[i].TimeStamp).getMonth()) {
                                count++;
                                reminderList.push(dailies[i]);
                                message += dailies[i].Name + ' @ ' + dailies[i].Time + "\r\n";
                                    }
                                }
                        for (let i = 0; i < weeklies.length; i++) {
                            if (year > new Date(weeklies[i].TimeStamp).getFullYear() || (year == new Date(weeklies[i].TimeStamp).getFullYear() &&
                                    month > new Date(weeklies[i].TimeStamp).getMonth())) {
                                        if (new Date(year, month, date).getDay() == new Date(weeklies[i].TimeStamp).getDay()) {
                                            count++;
                                            reminderList.push(weeklies[i]);
                                        message += weeklies[i].Name + ' @ ' + weeklies[i].Time + "\r\n";
                                        }
                            } else
                            if (year == new Date(weeklies[i].TimeStamp).getFullYear() && month == new Date(weeklies[i].TimeStamp).getMonth()) {
                                if (new Date(year, month, date).getDay() == new Date(weeklies[i].TimeStamp).getDay()) {
                                    count++;
                                    reminderList.push(weeklies[i]);
                                message += weeklies[i].Name + ' @ ' + weeklies[i].Time + "\r\n";
                                }
                            }
                        }
                        for (let i = 0; i < biweeklies.length; i++) {
                            if (year > new Date(biweeklies[i].TimeStamp).getFullYear() || (year == new Date(biweeklies[i].TimeStamp).getFullYear() &&
                                    month > new Date(biweeklies[i].TimeStamp).getMonth())) {
                                        if (new Date(year, month, date).getDay() == new Date(biweeklies[i].TimeStamp).getDay()) {
                                        if (((Math.floor(new Date(year, month, date))) - Math.floor(new Date(new Date(biweeklies[i].TimeStamp).getFullYear(), new Date(biweeklies[i].TimeStamp).getMonth(), new Date(biweeklies[i].TimeStamp).getDate()))) % 14 == 0){
                                            count++;
                                            reminderList.push(biweeklies[i]);
                                            message += biweeklies[i].Name + ' @ ' + biweeklies[i].Time + "\r\n";                                    }
                                }
                            } else
                            if (year == new Date(biweeklies[i].TimeStamp).getFullYear() && month == new Date(biweeklies[i].TimeStamp).getMonth()) {
                                if (new Date(year, month, date).getDay() == new Date(biweeklies[i].TimeStamp).getDay()) {
                                        if ((Math.floor(new Date(year, month, date)) - Math.floor(new Date(new Date(biweeklies[i].TimeStamp).getFullYear(), new Date(biweeklies[i].TimeStamp).getMonth(), new Date(biweeklies[i].TimeStamp).getDate()))) % 14 == 0){
                                            count++;
                                            reminderList.push(biweeklies[i]);
                                            message += biweeklies[i].Name + ' @ ' + biweeklies[i].Time + "\r\n";   
                                    }
                                }
                            }
                        }
                        makeScheduleArc();
    })
            } else {
                //     // User is signed out
                //     // ...
            }
        });
    }
    </script>

</body>

</html>
