<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>My BCIT Project</title>
    <meta name="comp1800 boilerplate code" content="my bcit project">
    <meta name="author" content="BCIT">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap, firebase-auth-ui -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.8.1/firebase-ui-auth.css" />

    <!-- Bootstrap FirebaseUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

    <!-- Firebase 8 CDNs-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>


    <!-- Link to the api keys for your firebase project -->
    <script src="scripts/firebaseAPI.js"></script>

    <!-- Optional styles and scripts of your own -->
    <!-- Google Icons (Material Design)-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles/my_style.css">

    <style>
        * {
            box-sizing: border-box;
        }

        #app-calendar {
            border: solid black 2px;
            height: 35vh;
            width: 80vw;
            margin: 0 10%;
            display: grid;
            overflow: hidden;
            text-align: center;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: 9% repeat(6, 1fr);
        }

        .block {
            border: black solid 1px;
            font-size: 12pt;
            height: 100%;
        }

        .xtrablock {
            background-color: rgba(50, 50, 50, 0.4) !important;
            color: white;
            height: 100%;
        }

        .weekend {
            color: red;
        }

        .date {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: ivory;
            margin: auto 0;
            line-height: 100%;
            border: black solid 1px;
            font-size: 10pt;
            height: 100%;
        }

        .today {
            color: darkblue;
            text-shadow: 0 0 5px green;
            font-weight: bold;
            border: solid green 2px;
        }

        .selected {
            background-color: brown;
        }

        .day {
            display: block;
            height: 100%;
            text-decoration: none;
        }

        .rem1 {
            background-color: rgba(255, 0 , 0, 0.1);
        }

        .rem2 {
            background-color: rgba(255, 127, 0, 0.2);
        }
        
        .rem3 {
            background-color: rgba(255, 255, 0, 0.5);
        }

        .rem4 {
            background-color: rgba(0, 255, 0, 0.6);
        }

        .rem5 {
            background-color: rgba(0, 0, 255, 0.7);
            color: yellow;
        }

        .rem6 {
            background-color: rgba(75, 0, 130, 0.8);
            color: rgb(255, 255, 134);
        }

        .rem7 {
            background-color: rgba(148, 0, 211, 0.9);
            color: white;
        }
    </style>

</head>

<body>

    <!-------------------------------------->
    <!-- The following is HTML for layout -->
    <!-------------------------------------->
    <!-- Header Navigation Bar -->
    <!-- Header Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-secondary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="color: white;">HEJ!</a>
            <a href="frontpage.html" type="button" class="btn btn-outline-dark" style="color: white;">Home</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="bi bi-search" style="color: white;"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <div style="float: right;">
                            <input id="title" type="text">
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- welcome and main part of the page -->
    <br />
    <div id="date" class="col" style="font-size: 4vw; font-weight: bold; margin-left: 10%; margin-bottom: 2%;"></div>

    <div id="app-calendar"></div>

    <br />
    <div class="row mx-5">
        <div class="col">
            <h1>Today's TO DO</h1>
        </div>
    </div>
    <div class="row mx-5">
        <div class="col-sm-1"></div>
        <div class="col-sm-7">
            <ul>
                <li>Eat lunch</li>
                <li>Walk the Dog</li>
                <li>Finish Assignment(due tmrw)</li>
            </ul>
        </div>
        <div class="col-sm-4 py-2"><input type="radio" class="btn-check a" name="btnradio" id="btnradio1"
                autocomplete="off" checked>
            <label class="btn btn-outline-secondary align-items-center" for="btnradio1">All Done</label></div>
    </div>
    <br />
    <div class="row mx-5">
        <div class="col">
            <h3>Quote of the day</h3>
        </div>
    </div>

    <div class="row mx-5">
        <div class="col">
            Lorem ipsum dolor sit amet consectetur adipisicing elit.
        </div>
    </div>

    <div style="height: 80px"></div>



    <div class="fixed-bottom py-3 bg-secondary align-items-center">
        <div class="container text-center py-0">
            <footer class="navbar bg-secondary fixed-bottom py-0">
                <a href="frontpage.html" i class="bi bi-arrow-left-circle mx-3 "
                    style="font-size:  2em; color: white"></a>
                <a href="calendar.html" class="bi bi-calendar-date" style="font-size: 2em; color: white;"></a>
                <a href="create_schedule.html" class="bi bi-plus-circle mx-3" style="font-size: 3em; color: white;"></a>
                <i class="bi bi-trophy" style="font-size: 2em; color: white;"></i>
                <a href="profile_user.html" i class="bi bi-person mx-3" style="font-size: 2em; color: white"></a>

            </footer>
        </div>
    </div>

    <!--------------------------------------------------------------------->
    <!-- JS files: Your own JavaScript functions included here    -->
    <!--------------------------------------------------------------------->
    <script>
        var userID
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
            "October", "November", "December"
        ]
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
        const fulldays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
        const monthdays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]

        let today = new Date(Date.now());
        let month = today.getMonth();
        let date = today.getDate();
        let year = today.getFullYear();
        let day = today.getDay();
        let firstday = new Date(year, month, 1);
        let lastday = new Date(year, month + 1, 0);

        const nth = function (d) {
            if (d > 3 && d < 21) return 'th';
            switch (d % 10) {
                case 1:
                    return "st";
                case 2:
                    return "nd";
                case 3:
                    return "rd";
                default:
                    return "th";
            }
        }
        // adding dates into db collection.
        function addDate2db() {
            for (let i = 1; i <= monthdays[month]; i++) {
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        var currentUser = db.collection("users").doc(user.uid)
                        userID = user.uid;
                        //get the document for current user.
                        currentUser.get()
                            .then(userDoc => {
                                //get user name
                                userName = userDoc.data().name;
                                // Start a new collection and add all data in it.
                                let docData = {
                                    weekday: ((firstday.getDay() + i - 1) % 7),
                                    activity: [],
                                    name: userName
                                };
                                db.collection("dates").doc(userID)
                                    .collection(months[month] + "_" + year)
                                    .doc(i.toString()).set(docData).then(() => {
                                        console.log("Document successfully written!");
                                    });
                            })
                    } else {}
                })
            }
        }
        addDate2db();
        document.getElementById("date").innerHTML = year + " " + months[month] + " " + date + nth(date) + ", " +
            fulldays[day];

        const isWeekend = block => {
            return block % 7 === ((1 + (7 - firstday.getDay())) % 7) || block % 7 === (7 - firstday.getDay());
        }

        const istoday = block => {
            return block === date;
        }

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                fillCalendar();
            }
        })

        // --------------------------------------
        // Making calendar
        // --------------------------------------
        const calendar = document.querySelector("#app-calendar");

        function fillCalendar() {
            for (let i = 0; i < 7; i++) {
                calendar.insertAdjacentHTML("beforeend",
                    `<div class="date ${i == 0 || i == 6 ? "weekend" : ""}">${days[i]}</div>`);
            }
            for (let xtrablock = 0; xtrablock < firstday.getDay(); xtrablock++) {
                calendar.insertAdjacentHTML("beforeend",
                    `<a class ="day" href="./day.html?uid=${userID}?${year}?${months[month-1]}?${monthdays[month - 1] + (xtrablock - firstday.getDay())}"><div class="xtrablock block">${monthdays[month - 1] + (xtrablock - firstday.getDay())}</div></a>`
                );
            }
            for (let block = 1; block <= monthdays[month]; block++) {
                const weekend = isWeekend(block);
                const now = istoday(block);
                calendar.insertAdjacentHTML("beforeend",
                    `<a class ="day" href="./day.html?uid=${userID}?${year}?${months[month]}?${block}"><div id="${year+'_'+month+'_'+block}" class="day${(firstday.getDay() + block - 1) % 7} block ${weekend ? "weekend" : ""} ${now ? "today" : ""}">${block}</div></a>`
                );
            }
            if (firstday.getDay() == 5 && monthdays[month] > 30 || firstday.getDay() == 6 && monthdays[month] >= 30) {
                for (let xtrablock = lastday.getDay() + 1; xtrablock < 7; xtrablock++) {
                    calendar.insertAdjacentHTML("beforeend",
                        `<a class ="day" href="./day.html?uid=${userID}?${month + 1 == 12 ? year + 1 : year}?${months[(month+1)%12]}?${xtrablock - lastday.getDay()}"><div class="xtrablock block">${xtrablock - lastday.getDay()}</div></a>`
                    );
                }
            } else {
                for (let xtrablock = lastday.getDay() + 1; xtrablock < 14; xtrablock++) {
                    calendar.insertAdjacentHTML("beforeend",
                        `<a class ="day" href="./day.html?uid=${userID}?${month + 1 == 12 ? year + 1 : year}?${months[(month+1)%12]}?${xtrablock - lastday.getDay()}"><div class="xtrablock block">${xtrablock - lastday.getDay()}</div></a>`
                    );
                }
            }
        }
        //-------------------------
        //Get reminder
        //-------------------------
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                var activities = [];
                let uid = user.uid;
                var reminderRef = db.collection("reminders");
                reminderRef.where("UserID", "==", user.uid).get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            activities.push(doc.data());
                            //             // doc.data() is never undefined for query doc snapshots
                        });
                        let dailies = [];
                        let weeklies = [];
                        let biweeklies = [];
                        activities.forEach(element => {
                            if (element.Frequency == "daily") {
                                dailies.push(new Date(element.TimeStamp));
                            } else if (element.Frequency == "weekly") {
                                weeklies.push(new Date(element.TimeStamp));
                            } else {
                                biweeklies.push(new Date(element.TimeStamp));
                            }
                        });
                        console.log(dailies[0].getFullYear() == year);
                        for (let i = 0; i < dailies.length; i++) {
                            if (year > dailies[i].getFullYear() || (year == dailies[i].getFullYear() &&
                                    month > dailies[i].getMonth())) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    addReminderClass(dailychange, index);
                                }
                            } else
                            if (year == dailies[i].getFullYear() && month == dailies[i].getMonth()) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    if (dailychange[index].innerHTML >= dailies[i].getDate()) {
                                        addReminderClass(dailychange, index);
                                    }
                                }
                            }
                        }
                        for (let i = 0; i < weeklies.length; i++) {
                            if (year > weeklies[i].getFullYear() || (year == weeklies[i].getFullYear() &&
                                    month > weeklies[i].getMonth())) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    if (dailychange[index].classList.contains('day' + weeklies[i]
                                    .getDay())) {
                                        addReminderClass(dailychange, index);
                                    }
                                }
                            } else
                            if (year == weeklies[i].getFullYear() && month == weeklies[i].getMonth()) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    if (dailychange[index].innerHTML >= dailies[i].getDate()) {
                                        // console.log(dailychange[index].classList.contains('rem1'));
                                        if (dailychange[index].classList.contains('day' + weeklies[i]
                                                .getDay())) {
                                            addReminderClass(dailychange, index);
                                        }
                                    }
                                }
                            }
                        }
                        for (let i = 0; i < biweeklies.length; i++) {
                            if (year > biweeklies[i].getFullYear() || (year == biweeklies[i].getFullYear() &&
                                    month > biweeklies[i].getMonth())) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    if (dailychange[index].classList.contains('day' + biweeklies[i]
                                    .getDay())) {
                                        if ((Math.floor(new Date(year, month, index).getTime()/(3600*1000*24)) - Math.floor(biweeklies[i].getTime()/(3600*1000*24))) % 14 == 0){
                                        addReminderClass(dailychange, index);
                                    }}
                                }
                            } else
                            if (year == biweeklies[i].getFullYear() && month == biweeklies[i].getMonth()) {
                                let dailychange = document.querySelectorAll("#app-calendar .block");
                                for (let index = 0; index < dailychange.length; index++) {
                                    if (dailychange[index].innerHTML >= dailies[i].getDate()) {
                                        // console.log(dailychange[index].classList.contains('rem1'));
                                        if (dailychange[index].classList.contains('day' + biweeklies[i]
                                                .getDay())) {
                                                    if ((Math.floor(new Date(year, month, index).getTime()/(3600*1000*24)) - Math.floor(biweeklies[i].getTime()/(3600*1000*24))) % 14 == 0){
                                            addReminderClass(dailychange, index);
                                        }
                                        }
                                    }
                                }
                            }
                        }
                    })

                // .then(() =>{
                //         var dailyCount = 0;
                //         for (let i =0; i< activities.length ;i++) {
                //         if (activities[i].Frequncy == 'daily') {
                //             dailyCount++;
                //         }     console.log(dailyCount);

                //     }
                //     }).catch((error) => {
                //         console.log("Error getting documents: ", error);
                //     });
            } else {
                //     // User is signed out
                //     // ...
            }
        });

        function addReminderClass(classArr, index) {
            if (classArr[index].classList.contains('rem6')) {
                classArr[index].classList.add('rem7');
            } else if (classArr[index].classList.contains('rem5')) {
                classArr[index].classList.add('rem6');
            } else if (classArr[index].classList.contains('rem4')) {
                classArr[index].classList.add('rem5');
            } else if (classArr[index].classList.contains('rem3')) {
                classArr[index].classList.add('rem4');
            } else if (classArr[index].classList.contains('rem2')) {
                classArr[index].classList.add('rem3');
            } else if (classArr[index].classList.contains('rem1')) {
                classArr[index].classList.add('rem2');
            } else {
                classArr[index].classList.add('rem1');
            }
        }

        // --------------------------------------
        // set calendar toggle action
        // --------------------------------------
        // document.querySelectorAll("#app-calendar .block").forEach(block => {
        //     block.addEventListener("click", e => {
        //         e.currentTarget.classList.toggle("selected");
        //     })
        // })
    </script>

</body>

</html>